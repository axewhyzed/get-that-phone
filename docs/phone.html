<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Phone Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
</head>
<body>
  <main class="page">
    <header class="phone-header">
      <div class="phone-title">
        <h1 id="phoneName">Loading…</h1>
        <div class="meta-line">
          <span id="price" class="price"></span>
          <span id="release" class="release"></span>
        </div>
      </div>
    </header>

    <section class="phone-grid">
      <!-- Compact top-left icon/gallery -->
      <aside class="phone-aside" aria-label="images">
        <div id="gallery" class="gallery"></div>
      </aside>

      <!-- Wide specs column -->
      <section class="phone-specs">
        <div id="specs" class="specs"></div>
      </section>
    </section>
  </main>

  <script>
    // ---------- helpers ----------
    const qs = (s, r = document) => r.querySelector(s);
    const qsa = (s, r = document) => Array.from(r.querySelectorAll(s));
    const text = (el, v) => { if (el && v) el.textContent = v; };

    function pushRow(lines, k, v) {
      lines.push(
        `<div class="spec-row">
          <span class="spec-key">${k}</span>
          <span class="spec-val">${v}</span>
        </div>`
      );
    }

    // One-level nested renderer: Category -> Subcategory (object) -> rows
    function renderSpecs(specs) {
      const root = qs('#specs');
      const lines = [];

      Object.entries(specs || {}).forEach(([category, items]) => {
        if (!items || typeof items !== 'object' || !Object.keys(items).length) return;

        lines.push(`<details class="spec-category" open>
          <summary>${category}</summary>
          <div class="spec-items">`);

        Object.entries(items).forEach(([key, value]) => {
          // Subcategory block (e.g., Primary/Secondary/Features or SIM 1/SIM 2/Other)
          if (value && typeof value === 'object' && Object.keys(value).length) {
            lines.push(`<div class="spec-subcategory">
              <div class="spec-subcategory-title">${key}</div>`);

            Object.entries(value).forEach(([k2, v2]) => {
              if (v2 === null || v2 === undefined || v2 === '') return;
              pushRow(lines, k2, v2);
            });

            lines.push(`</div>`);
          } else if (value !== null && value !== undefined && value !== '') {
            // Flat row
            pushRow(lines, key, value);
          }
        });

        lines.push(`</div></details>`);
      });

      root.innerHTML = lines.join('');
    }

    function renderImages(images, phoneName) {
      const wrap = qs('#gallery');
      wrap.innerHTML = '';

      const gallery = (images || []).filter(i => i.image_type === 'gallery').slice(0, 3);
      if (!gallery.length) return;

      gallery.forEach((img, idx) => {
        const url = img.image_url || img.url;
        if (!url) return;
        const alt = img.alt_text || img.alt || phoneName || 'Phone';
        const div = document.createElement('div');
        div.className = 'thumb';
        div.innerHTML = `<img class="phone-thumb" src="${url}" alt="${alt}">`;
        wrap.appendChild(div);
      });
    }

    async function loadPhone() {
      const params = new URLSearchParams(location.search);
      const id = params.get('id');

      let data = null;

      // 1) global (pre-injected)
      if (window.__PHONE__) {
        data = window.__PHONE__;
      }

      // 2) API by id
      if (!data && id) {
        try {
          const r = await fetch(`/api/phone?id=${encodeURIComponent(id)}`, { cache: 'no-store' });
          if (r.ok) data = await r.json();
        } catch {}
      }

      // 3) local fallback
      if (!data) {
        try {
          const r = await fetch('phoneData.json', { cache: 'no-store' });
          if (r.ok) {
            const specsOnly = await r.json();
            data = { specs: specsOnly.specs, metadata: specsOnly.metadata, images: [] };
          }
        } catch {}
      }

      if (!data) {
        text(qs('#phoneName'), 'Not found');
        return;
      }

      // Expected shape:
      // data: { id?, phone_id?, specs, metadata, images? }
      const name = data.metadata?.['Phone Name'] || 'Phone';
      const price = data.metadata?.Price || '';
      const release = data.metadata?.['Release Date'] || '';

      document.title = `${name} — Details`;
      text(qs('#phoneName'), name);
      text(qs('#price'), price);
      text(qs('#release'), release ? `Release: ${release}` : '');

      renderImages(data.images || [], name);
      renderSpecs(data.specs || {});
    }

    loadPhone();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Phone Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="assets/style.css" rel="stylesheet" />
</head>

<body>
    <main class="page">
        <header class="phone-header">
            <div class="phone-title">
                <h1 id="phoneName">Loadingâ€¦</h1>
                <div class="meta-line">
                    <span id="price" class="price"></span>
                    <span id="release" class="release"></span>
                </div>
            </div>
        </header>

        <section class="phone-grid">
            <!-- Compact top-left icon/gallery -->
            <aside class="phone-aside" aria-label="images">
                <div id="gallery" class="gallery"></div>
            </aside>

            <!-- Wide specs column -->
            <section class="phone-specs">
                <div id="specs" class="specs"></div>
            </section>
        </section>
    </main>

    <script>
        const API_URL = 'https://get-that-phone.vercel.app/api';
        const params = new URLSearchParams(window.location.search);
        const phoneId = params.get('id');
        let images = [];
        let currentIndex = 0;

        // Safely add sizing params without creating a second "?"
        const withParams = (url, query) => {
            if (!url) return '';
            return url.includes('?') ? `${url}&${query}` : `${url}?${query}`;
        };

        // Accept flat array of images with image_url/alt_text
        function normalizeImages(raw) {
            if (!raw) return [];
            if (!Array.isArray(raw)) return [];

            return raw
                .filter(img => img && img.image_url && (img.image_type === 'gallery' || !img.image_type))
                .map(img => ({
                    url: img.image_url || '',
                    alt: img.alt_text || 'Phone image'
                }));
        }

        async function loadPhone() {
            try {
                const res = await fetch(`${API_URL}/phone-detail?id=${encodeURIComponent(phoneId || '')}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                const meta = data.metadata || {};
                document.getElementById('phoneName').textContent = (meta['Phone Name'] || 'Phone').toString();

                images = normalizeImages(data.images).slice(0, 3);

                displayImages();
                displayMetadata(meta);
                displaySpecs(data.specs || {});

                document.getElementById('loading').style.display = 'none';
                document.getElementById('phoneContent').style.display = 'grid';
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('loading').innerHTML = `<p class="error">Failed to load phone details</p>`;
            }
        }

        function displayImages() {
            const sliderImages = document.getElementById('sliderImages');
            const thumbnails = document.getElementById('thumbnails');

            if (!images.length) {
                sliderImages.innerHTML = '<div class="no-image-big">ðŸ“±</div>';
                thumbnails.innerHTML = '';
                return;
            }

            currentIndex = 0;

            sliderImages.innerHTML = images.map((img, i) => `
      <img src="${withParams(img.url, 'q=60&w=200&h=400&fit=contain')}" 
           alt="${img.alt}"
           class="slider-img ${i === 0 ? 'active' : ''}"
           onclick="openModal('${img.url}')" 
           loading="${i === 0 ? 'eager' : 'lazy'}">
    `).join('');

            thumbnails.innerHTML = images.map((img, i) => `
      <img src="${withParams(img.url, 'q=50&w=80&h=150&fit=contain')}" 
           alt="${img.alt}"
           class="thumb ${i === 0 ? 'active' : ''}"
           onclick="goToSlide(${i})" 
           loading="lazy">
    `).join('');

            document.getElementById('prevBtn').onclick = () => navigate(-1);
            document.getElementById('nextBtn').onclick = () => navigate(1);
        }

        function goToSlide(index) {
            const sliders = document.querySelectorAll('.slider-img');
            const thumbs = document.querySelectorAll('.thumb');
            if (!sliders.length) return;

            sliders[currentIndex]?.classList.remove('active');
            thumbs[currentIndex]?.classList.remove('active');

            currentIndex = index;
            sliders[currentIndex]?.classList.add('active');
            thumbs[currentIndex]?.classList.add('active');
        }

        function navigate(dir) {
            if (!images.length) return;
            goToSlide((currentIndex + dir + images.length) % images.length);
        }

        function displayMetadata(meta) {
            const price = meta['Price'] ? String(meta['Price']).trim() : 'N/A';
            const release = meta['Release Date'] ? String(meta['Release Date']).trim() : 'N/A';

            document.getElementById('metadata').innerHTML = `
      <div class="meta-item">
        <span class="meta-label">Price</span>
        <span class="meta-value">${price}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Release</span>
        <span class="meta-value">${release}</span>
      </div>
    `;
        }

        function displaySpecs(specs) {
            const specsDiv = document.getElementById('specs');

            if (!specs || Object.keys(specs).length === 0) {
                specsDiv.innerHTML = '<div class="specs-empty">No specs available</div>';
                return;
            }

            let html = '';

            for (const [category, items] of Object.entries(specs)) {
                if (!items || typeof items !== 'object') continue;

                html += `<details class="spec-category" open>
        <summary>${String(category).trim()}</summary>
        <div class="spec-items">`;

                for (const [key, value] of Object.entries(items)) {
                    // Skip null/undefined values
                    if (value === null || value === undefined) continue;

                    // If value is an object (nested: Rear Camera > Features, SIM 1, etc)
                    if (typeof value === 'object' && !Array.isArray(value)) {
                        html += `<div class="spec-subcategory">
            <div class="spec-subcategory-title">${String(key).trim()}</div>`;

                        for (const [subKey, subVal] of Object.entries(value)) {
                            if (subVal === null || subVal === undefined) continue;
                            html += `<div class="spec-row">
              <span class="spec-key">${String(subKey).trim()}</span>
              <span class="spec-val">${String(subVal).trim()}</span>
            </div>`;
                        }

                        html += `</div>`;
                    } else if (Array.isArray(value)) {
                        // Handle arrays (e.g., list of values) â€“ join them
                        html += `<div class="spec-row">
            <span class="spec-key">${String(key).trim()}</span>
            <span class="spec-val">${value.map(v => String(v).trim()).join(', ')}</span>
          </div>`;
                    } else {
                        // Regular spec row
                        html += `<div class="spec-row">
            <span class="spec-key">${String(key).trim()}</span>
            <span class="spec-val">${String(value).trim()}</span>
          </div>`;
                    }
                }

                html += `</div></details>`;
            }

            specsDiv.innerHTML = html || '<div class="specs-empty">No specs available</div>';
        }

        function openModal(src) {
            if (!src) return;
            document.getElementById('imageModal').style.display = 'flex';
            document.getElementById('modalImage').src = src;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        loadPhone();
    </script>


</body>

</html>